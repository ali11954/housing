{% extends 'base.html' %}
{% block title %}ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
<style>
    body { background-color: #f8f9fa; padding: 20px 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    h2 { text-align: center; color: #0d6efd; margin-bottom: 25px; font-weight: 700; }
    .filter-form select, .filter-form input { max-width: 250px; height: 45px; font-size: 1rem; }
    .filter-form { margin-bottom: 20px; }
    .btn { min-width: 130px; font-weight: 600; }
    table { background-color: #fff; }
    tfoot tr { background-color: #d1e7dd !important; font-weight: 700; }
    .table-responsive { border-radius: 10px; overflow: hidden; }
    .total-row { background-color: #e3f2fd !important; }
    @media (max-width: 575px) {
        .filter-form { flex-direction: column; align-items: stretch; }
        .filter-form select, .filter-form input { max-width: 100%; margin-bottom: 0.75rem; }
        .d-flex.justify-content-center.gap-3.mt-4 { flex-direction: column; gap: 0.75rem !important; }
        .btn { width: 100%; }
    }
</style>

<div class="container mt-4">
    <h2>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>

    <!-- ÙÙ„ØªØ± Ø§Ù„Ø³ÙƒÙ† ÙˆØ§Ù„Ø´Ù‡Ø± -->
    <form method="get" class="row g-3 filter-form justify-content-center">
        <div class="col-auto">
            <select class="form-select" name="housing_units_id" onchange="this.form.submit()" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙƒÙ†">
                <option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙƒÙ†Ø§Øª --</option>
                {% for unit in units %}
                    <option value="{{ unit.id }}" {% if selected_housing == unit.id|string %}selected{% endif %}>{{ unit.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <input type="month" class="form-control" name="month" value="{{ selected_month }}" onchange="this.form.submit()" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø±" />
        </div>
    </form>
<!-- ğŸ”¥ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
<div class="card shadow-sm border-0 mb-4 bg-light">
    <div class="card-body py-3">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="border-end">
                    <h5 class="text-primary mb-1">{{ totals.daily_info.days_passed }}/{{ totals.daily_info.total_days }}</h5>
                    <small class="text-muted">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠØ© / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="border-end">
                    <h5 class="text-success mb-1">{{ totals.daily_info.today }}</h5>
                    <small class="text-muted">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="border-end">
                    <h5 class="text-info mb-1">
                        {% if daily_calculation %}Ø­Ø³Ø§Ø¨ ÙŠÙˆÙ…ÙŠ{% else %}Ø­Ø³Ø§Ø¨ Ø´Ù‡Ø±ÙŠ{% endif %}
                    </h5>
                    <small class="text-muted">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex gap-2 justify-content-center">
                    <a href="{{ url_for('main.consumption_report', month=selected_month, housing_units_id=selected_housing, daily=true) }}"
                       class="btn btn-sm {% if daily_calculation %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ
                    </a>
                    <a href="{{ url_for('main.consumption_report', month=selected_month, housing_units_id=selected_housing, daily=false) }}"
                       class="btn btn-sm {% if not daily_calculation %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
    {% if data %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒÙ†Ø§Øª</h5>
                    <h3 class="mb-0">{{ data|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</h5>
                    <h3 class="mb-0">{{ "%.0f"|format(totals.overall_cost or 0) }} ï·¼</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø§ÙƒÙ†ÙŠÙ†</h5>
                    <h3 class="mb-0">{{ "%.1f"|format(totals.total_avg_residents or 0) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©/Ø³Ø§ÙƒÙ†</h5>
                    <h3 class="mb-0">{{ "%.0f"|format(totals.total_cost_per_resident or 0) }} ï·¼</h3>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
    <div class="table-responsive shadow-sm bg-white rounded">
        <table class="table table-striped table-bordered text-center align-middle mb-0">
            <thead class="table-primary">
                <tr>
                    <th>#</th>
                    <th>Ø§Ù„Ø³ÙƒÙ†</th>
                    <th>Ø§Ù„Ø´Ù‡Ø±</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (ï·¼)</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§ÙƒÙ†ÙŠÙ†</th>
                    <th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø§ÙƒÙ†ÙŠÙ†</th>
                    <th>ØªÙƒÙ„ÙØ© Ø§Ù„Ø³Ø§ÙƒÙ† Ø§Ù„ÙˆØ§Ø­Ø¯ (ï·¼)</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td class="text-start">{{ row.unit_name }}</td>
                    <td>{{ row.month }}</td>
                    <td class="fw-bold text-success">{{ "{:,.0f}".format(row.total_cost or 0) }}</td>
                    <td>{{ row.total_residents or 0 }}</td>
                    <td>{{ "%.1f"|format(row.avg_residents or 0) }}</td>
                    <td class="fw-bold text-primary">{{ "{:,.0f}".format(row.cost_per_resident or 0) }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="fas fa-info-circle fa-2x mb-3 d-block"></i>
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            {% if data %}
            <tfoot>
                <tr class="total-row">
                    <td colspan="2" class="text-end fw-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td>
                    <td class="fw-bold">{{ selected_month }}</td>
                    <td class="fw-bold text-success">{{ "{:,.0f}".format(totals.overall_cost or 0) }}</td>
                    <td class="fw-bold">{{ totals.total_residents or 0 }}</td>
                    <td class="fw-bold">{{ "%.1f"|format(totals.total_avg_residents or 0) }}</td>
                    <td class="fw-bold text-primary">{{ "{:,.0f}".format(totals.total_cost_per_resident or 0) }}</td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
    {% if data %}
    <div class="d-flex justify-content-center gap-3 mt-4 flex-wrap">
        <button onclick="window.print()" class="btn btn-outline-primary">
            <i class="fas fa-print me-2"></i>Ø·Ø¨Ø§Ø¹Ø©
        </button>
        <a href="{{ url_for('main.export_consumption_pdf', month=selected_month, unit_id=selected_housing) }}" class="btn btn-danger">
            <i class="fas fa-file-pdf me-2"></i>ØªØµØ¯ÙŠØ± PDF
        </a>
        <a href="{{ url_for('main.export_consumption_excel', month=selected_month, housing_unit_id=selected_housing) }}" class="btn btn-success">
            <i class="fas fa-file-excel me-2"></i>ØªØµØ¯ÙŠØ± Excel
        </a>
    </div>
    {% endif %}
</div>

<!-- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
<style>
@media print {
    body * {
        visibility: hidden;
    }
    .container, .container * {
        visibility: visible;
    }
    .container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
    .btn, .filter-form, .card {
        display: none !important;
    }
    table {
        width: 100%;
        font-size: 12px;
    }
}
</style>

<script>
// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
document.addEventListener('DOMContentLoaded', function() {
    const housingSelect = document.querySelector('select[name="housing_units_id"]');
    const monthInput = document.querySelector('input[name="month"]');

    housingSelect.addEventListener('change', function() {
        updateTitle();
    });

    monthInput.addEventListener('change', function() {
        updateTitle();
    });

    function updateTitle() {
        const selectedHousing = housingSelect.options[housingSelect.selectedIndex].text;
        const selectedMonth = monthInput.value;
        document.querySelector('h2').textContent = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ - ${selectedHousing} - ${selectedMonth}`;
    }

    // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙˆÙ„ÙŠ
    updateTitle();
});
</script>

<!-- Ø¥Ø¶Ø§ÙØ© Font Awesome Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% endblock %}