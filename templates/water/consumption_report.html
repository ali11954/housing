{% extends 'base.html' %}
{% block title %}تقرير المصروفات{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
<style>
    body { background-color: #f8f9fa; padding: 20px 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    h2 { text-align: center; color: #0d6efd; margin-bottom: 25px; font-weight: 700; }
    .filter-form select, .filter-form input { max-width: 250px; height: 45px; font-size: 1rem; }
    .filter-form { margin-bottom: 20px; }
    .btn { min-width: 130px; font-weight: 600; }
    table { background-color: #fff; }
    tfoot tr { background-color: #d1e7dd !important; font-weight: 700; }
    .table-responsive { border-radius: 10px; overflow: hidden; }
    .total-row { background-color: #e3f2fd !important; }
    @media (max-width: 575px) {
        .filter-form { flex-direction: column; align-items: stretch; }
        .filter-form select, .filter-form input { max-width: 100%; margin-bottom: 0.75rem; }
        .d-flex.justify-content-center.gap-3.mt-4 { flex-direction: column; gap: 0.75rem !important; }
        .btn { width: 100%; }
    }
</style>

<div class="container mt-4">
    <h2>تقرير الاستهلاك الشهري</h2>

    <!-- فلتر السكن والشهر -->
    <form method="get" class="row g-3 filter-form justify-content-center">
        <div class="col-auto">
            <select class="form-select" name="housing_units_id" onchange="this.form.submit()" aria-label="اختيار السكن">
                <option value="">-- جميع السكنات --</option>
                {% for unit in units %}
                    <option value="{{ unit.id }}" {% if selected_housing == unit.id|string %}selected{% endif %}>{{ unit.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <input type="month" class="form-control" name="month" value="{{ selected_month }}" onchange="this.form.submit()" aria-label="اختيار الشهر" />
        </div>
    </form>

    <!-- إحصائيات سريعة -->
    {% if data %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">عدد السكنات</h5>
                    <h3 class="mb-0">{{ data|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">إجمالي التكاليف</h5>
                    <h3 class="mb-0">{{ "%.0f"|format(totals.overall_cost or 0) }} ﷼</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">متوسط الساكنين</h5>
                    <h3 class="mb-0">{{ "%.1f"|format(totals.total_avg_residents or 0) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">متوسط التكلفة/ساكن</h5>
                    <h3 class="mb-0">{{ "%.0f"|format(totals.total_cost_per_resident or 0) }} ﷼</h3>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- جدول التقرير -->
    <div class="table-responsive shadow-sm bg-white rounded">
        <table class="table table-striped table-bordered text-center align-middle mb-0">
            <thead class="table-primary">
                <tr>
                    <th>#</th>
                    <th>السكن</th>
                    <th>الشهر</th>
                    <th>الإجمالي (﷼)</th>
                    <th>إجمالي الساكنين</th>
                    <th>متوسط الساكنين</th>
                    <th>تكلفة الساكن الواحد (﷼)</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td class="text-start">{{ row.unit_name }}</td>
                    <td>{{ row.month }}</td>
                    <td class="fw-bold text-success">{{ "{:,.0f}".format(row.total_cost or 0) }}</td>
                    <td>{{ row.total_residents or 0 }}</td>
                    <td>{{ "%.1f"|format(row.avg_residents or 0) }}</td>
                    <td class="fw-bold text-primary">{{ "{:,.0f}".format(row.cost_per_resident or 0) }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="fas fa-info-circle fa-2x mb-3 d-block"></i>
                        لا توجد بيانات للعرض في الفترة المحددة
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            {% if data %}
            <tfoot>
                <tr class="total-row">
                    <td colspan="2" class="text-end fw-bold">الإجمالي:</td>
                    <td class="fw-bold">{{ selected_month }}</td>
                    <td class="fw-bold text-success">{{ "{:,.0f}".format(totals.overall_cost or 0) }}</td>
                    <td class="fw-bold">{{ totals.total_residents or 0 }}</td>
                    <td class="fw-bold">{{ "%.1f"|format(totals.total_avg_residents or 0) }}</td>
                    <td class="fw-bold text-primary">{{ "{:,.0f}".format(totals.total_cost_per_resident or 0) }}</td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </div>

    <!-- أزرار التصدير -->
    {% if data %}
    <div class="d-flex justify-content-center gap-3 mt-4 flex-wrap">
        <button onclick="window.print()" class="btn btn-outline-primary">
            <i class="fas fa-print me-2"></i>طباعة
        </button>
        <a href="{{ url_for('main.export_consumption_pdf', month=selected_month, unit_id=selected_housing) }}" class="btn btn-danger">
            <i class="fas fa-file-pdf me-2"></i>تصدير PDF
        </a>
        <a href="{{ url_for('main.export_consumption_excel', month=selected_month, housing_unit_id=selected_housing) }}" class="btn btn-success">
            <i class="fas fa-file-excel me-2"></i>تصدير Excel
        </a>
    </div>
    {% endif %}
</div>

<!-- تنسيقات الطباعة -->
<style>
@media print {
    body * {
        visibility: hidden;
    }
    .container, .container * {
        visibility: visible;
    }
    .container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
    .btn, .filter-form, .card {
        display: none !important;
    }
    table {
        width: 100%;
        font-size: 12px;
    }
}
</style>

<script>
// تحديث العنوان عند التحديد
document.addEventListener('DOMContentLoaded', function() {
    const housingSelect = document.querySelector('select[name="housing_units_id"]');
    const monthInput = document.querySelector('input[name="month"]');

    housingSelect.addEventListener('change', function() {
        updateTitle();
    });

    monthInput.addEventListener('change', function() {
        updateTitle();
    });

    function updateTitle() {
        const selectedHousing = housingSelect.options[housingSelect.selectedIndex].text;
        const selectedMonth = monthInput.value;
        document.querySelector('h2').textContent = `تقرير الاستهلاك الشهري - ${selectedHousing} - ${selectedMonth}`;
    }

    // التحديث الأولي
    updateTitle();
});
</script>

<!-- إضافة Font Awesome للأيقونات -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% endblock %}