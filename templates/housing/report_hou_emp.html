{% extends 'base.html' %}
{% block title %}تقارير الموظفون{% endblock %}
{% block content %}

<div class="container mt-4">

    <!-- شريط علوي محسن -->
    <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light rounded shadow-sm">
        <!-- زر العودة -->
        <a href="{{ url_for('main.home') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-right"></i> العودة للرئيسية
        </a>

        <!-- العنوان -->
        <h1 class="m-0 text-center flex-grow-1 text-primary">تقرير السكنات والموظفين</h1>

        <!-- أزرار التصدير -->
        <div>
            <a href="{{ url_for('main.housing_report_excel') }}" class="btn btn-success btn-sm">
                <i class="fas fa-file-excel"></i> تصدير Excel
            </a>
            <a href="{{ url_for('main.housing_report_pdf') }}" class="btn btn-danger btn-sm">
                <i class="fas fa-file-pdf"></i> تصدير PDF
            </a>
        </div>
    </div>

    <!-- إحصائيات سريعة - محسوبة من البيانات المتاحة -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white shadow-sm">
                <div class="card-body text-center">
                    <h4 class="card-title">
                        {% set total_emps = [] %}
                        {% for housing in housings %}
                            {% for emp in housing.employees %}
                                {% if total_emps.append(1) %}{% endif %}
                            {% endfor %}
                        {% endfor %}
                        {{ total_emps|length }}
                    </h4>
                    <p class="card-text">إجمالي الموظفين المسكنين</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white shadow-sm">
                <div class="card-body text-center">
                    <h4 class="card-title">{{ housings|length if housings else 0 }}</h4>
                    <p class="card-text">عدد السكنات</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white shadow-sm">
                <div class="card-body text-center">
                    <h4 class="card-title">
                        {% set occupied_rooms = [] %}
                        {% for housing in housings %}
                            {% for emp in housing.employees %}
                                {% if emp.room_number and emp.bed_number %}
                                    {% if occupied_rooms.append(1) %}{% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        {{ occupied_rooms|length }}
                    </h4>
                    <p class="card-text">أسرة مشغولة</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white shadow-sm">
                <div class="card-body text-center">
                    <h4 class="card-title">
                        {% set total_rooms = [] %}
                        {% for housing in housings %}
                            {% for emp in housing.employees %}
                                {% if total_rooms.append(1) %}{% endif %}
                            {% endfor %}
                        {% endfor %}
                        {% set occupancy_rate = (occupied_rooms|length / total_rooms|length * 100) if total_rooms|length > 0 else 0 %}
                        {{ "%.1f"|format(occupancy_rate) }}%
                    </h4>
                    <p class="card-text">نسبة الإشغال</p>
                </div>
            </div>
        </div>
    </div>

    <!-- محتوى التقرير -->
    {% if housings and housings|length > 0 %}
        {% for housing in housings %}
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-gradient-primary text-white py-3">
                <h2 class="mb-0 text-center">
                    <i class="fas fa-building"></i> السكن: {{ housing.name if housing.name is defined else 'غير محدد' }}
                    <span class="badge bg-light text-primary ms-2">
                        {{ housing.employees|length if housing.employees is defined else 0 }} موظف
                    </span>
                </h2>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="20%">اسم الموظف</th>
                                <th width="15%">الوظيفة</th>
                                <th width="15%">القسم</th>
                                <th width="10%">رقم الغرفة</th>
                                <th width="10%">رقم السرير</th>
                                <th width="10%">الحالة</th>
                                <th width="20%">الشركة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if housing.employees and housing.employees|length > 0 %}
                                {% for employee in housing.employees %}
                                <tr>
                                    <td class="fw-bold">{{ employee.name if employee.name is defined else 'غير محدد' }}</td>
                                    <td>{{ employee.job_title if employee.job_title is defined else "غير محدد" }}</td>
                                    <td>{{ employee.department if employee.department is defined else "غير محدد" }}</td>
                                    <td class="text-center">{{ employee.room_number if employee.room_number is defined else "-" }}</td>
                                    <td class="text-center">{{ employee.bed_number if employee.bed_number is defined else "-" }}</td>
                                    <td class="text-center">
                                        {% if employee.room_number is defined and employee.bed_number is defined and employee.room_number and employee.bed_number %}
                                            <span class="badge bg-success">مسكن</span>
                                        {% else %}
                                            <span class="badge bg-secondary">غير مسكن</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-muted">{{ employee.company_name if employee.company_name is defined else "غير محدد" }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">
                                        <i class="fas fa-info-circle fa-2x mb-2"></i><br>
                                        لا يوجد موظفين مسجلين في هذا السكن
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-body text-center py-5">
                <i class="fas fa-building fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">لا توجد سكنات متاحة</h4>
                <p class="text-muted">لم يتم العثور على أي سكنات في النظام</p>
            </div>
        </div>
    {% endif %}

</div>

<style>
    :root {
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .bg-gradient-primary {
        background: var(--gradient-primary) !important;
    }

    .card {
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.2s ease-in-out;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .card-header {
        border-bottom: none;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        color: #495057;
        background-color: #f8f9fa;
    }

    .table td {
        vertical-align: middle;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }

    .btn {
        border-radius: 6px;
        font-weight: 500;
    }

    /* تخصيص شريط التمرير للجدول */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // إضافة تأثيرات تفاعلية للجداول
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
            this.style.transition = 'background-color 0.2s ease';
        });

        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });

    // إضافة وقت التحديث
    const timeElement = document.createElement('div');
    timeElement.className = 'text-center text-muted mb-3 small';
    timeElement.id = 'current-time';
    document.querySelector('.container').insertBefore(timeElement, document.querySelector('.card'));

    function updateTime() {
        const now = new Date();
        const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        const arabicDate = now.toLocaleDateString('ar-EG', options);
        timeElement.textContent = `آخر تحديث: ${arabicDate}`;
    }

    updateTime();
    setInterval(updateTime, 1000);
});
</script>

{% endblock %}